- hosts: all
  become: True
  become_user: root
  vars:
    installation_dir : /opt/hadoop
    etc_hosts:
      - ip: "192.168.85.2"
        name: "namenode"
      - ip: "192.168.85.3"
        name: "datanode_1"
      - ip: "192.168.85.4"
        name: "datanode_2"

  tasks:
    - name: update system
      ansible.builtin.apt:
        upgrade: yes
        update_cache: yes
        cache_valid_time: 86400 #One day

    - name: Add extra hosts entries to /etc/hosts
      lineinfile:
        path: /etc/hosts
        create: yes
        line: "{{ item.ip }} {{ item.name }}"
        state: present
      loop: "{{ etc_hosts }}"
      become: yes

    ##################################################################
    - name: Create Netplan configuration for enp3s0 interface with DHCP
      copy:
        dest: "/etc/netplan/00-3ia3-config.yaml"
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              enp3s0:
                dhcp4: false
                addresses:
                  - "{{ remote_ip }}"
        owner: root
        group: root
        mode: '0600'

    - name: Apply Netplan configuration
      command: netplan apply
      become: true
    ##################################################################
    #SSH gakoak sortu eta elkarbanatzea faltako litzateke. Isardeko makinetan eginda dago
    ##################################################################
    - name: Install JRE after apt update
      become: yes
      apt:
        name: 
          - default-jre
        state: present
        update_cache: yes
    - name: Install ACL (Required to download as hadoop user)
      become: yes
      apt:
        name: 
          - acl
        state: present
        update_cache: yes
    - name:  Beharrezko direktorioa sortu
      become: yes
      file:
        path: "{{installation_dir}}"
        state: directory
        mode: 0755
        owner: hadoop
        group: hadoop
        
    - name: Hadoop lortu
      become: yes
      become_user: hadoop
      unarchive:
        src: https://www.apache.org/dyn/closer.cgi/hadoop/common/hadoop-3.4.1/hadoop-3.4.1.tar.gz
        dest: "{{installation_dir}}"
        mode: 0755
        remote_src: yes


